###SPOILER ALERT### DO NOT READ THIS FILE IF UNFAMILIAR WITH R+L=J THEORY

namespace = tower_of_joy

#Ned's Canon Companions, decide whether to back Ned on day 0
character_event = {
	id = tower_of_joy.1
	desc = "EVTDESCtower_of_joy.1"
	
	is_triggered_only = yes
	
	trigger = {
		has_character_flag = TOJ_companion
	}
	
	option = {
		name = "EVTOPTAtower_of_joy.1" #I will fight for Lyanna
		set_character_flag = tower_of_joy
		hidden_tooltip = {
			remove_title = job_chancellor	
			remove_title = job_treasurer
			remove_title = job_marshal	
			remove_title = job_spymaster
			remove_title = job_castellan
		}
		k_north = {
			holder_scope = {
				location = {
					ROOT = {
						spawn_unit = {
							province = PREV
							leader = ROOT
							owner = PREVPREV
							troops = {
								archers = { 10 10 }
								heavy_infantry = { 32 32 }
								light_infantry = { 44 44 }	
								light_cavalry = { 8 8 }		
								knights = { 6 6 }						
							}
							attrition = 1.0
							disband_on_peace = yes
						}
					}	
				}
				opinion = {
					modifier = opinion_companion_TOJ
					who = ROOT
					years = 100
				}
				reverse_opinion = {
					modifier = opinion_companion_TOJ
					who = ROOT
					years = 100
				}
			}
		}	
	}
	option = {
		name = "EVTOPTBtower_of_joy.1" #No
		ai_chance = { factor = 0 }
		prestige = -30
		k_north = {
			holder_scope = {
				opinion = {
					modifier = opinion_coward_TOJ
					who = ROOT
					years = 10
				}
			}
		}
		clr_character_flag = TOJ_companion
	}

}

#Check number of companions/kingsguard monthly during war
character_event = {
	id = tower_of_joy.198
	
	is_triggered_only = yes
	hide_window = yes
	has_global_flag = roberts_rebellion
	
	trigger = {
		character = 4059	
		NOT = { has_character_flag = tower_of_joy }
		NOT = { has_global_flag = TOJ_resolved }	
	}
	
	immediate = {
		#Check for 3 kingsguard
		if = {
			limit = {
				NOT = {
					kingsguard = {
						count = 3
						is_alive = yes
						trait = wikid
						has_character_flag = TOJ_kingsguard
					}
				}
			}
			kingsguard = {
				limit = {
					is_alive = yes
					NOT = { trait = wikid }				
					prisoner = no
					is_ill = no
					has_epidemic = no
					in_command = no
					NOT = { has_severe_disability_trigger = yes }				
					NOT = { character = 3190 } #Jaime Lannister
				}
				character_event = { id = tower_of_joy.3 }
			}
		}		
		character_event = { id = tower_of_joy.198 days = 30 }
		
		random_dynasty_member = { 
			limit = {
				has_character_flag = TOJ_leader
				is_alive = yes			
				age = 15
				NOT = { trait = incapable }
			}	
			character_event = { id = tower_of_joy.199 }
			break = yes
		}	
		k_north = {
			holder_scope = {
				if = { 
					limit = {			
						age = 15
						NOT = { trait = incapable }
						sibling = ROOT
					}
					set_character_flag = TOJ_leader
					character_event = { id = tower_of_joy.199 }
					break = yes
				}
			}
		}	
		random_dynasty_member = { 
			limit = {
				is_alive = yes
				age = 15
				NOT = { trait = incapable }
				sibling = ROOT
			}
			set_character_flag = TOJ_leader
			character_event = { id = tower_of_joy.199 }
			break = yes
		}
		random_dynasty_member = { 
			limit = {
				is_alive = yes
				age = 15
				NOT = { trait = incapable }
			}
			set_character_flag = TOJ_leader
			character_event = { id = tower_of_joy.199 }
			break = yes
		}		
	}
	
	option = {
		name = OK
	}	
}
character_event = {
	id = tower_of_joy.199
	
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		dynasty = 59
	}
	
	immediate = {
		#Check for 5 companions
		if = {
			limit = {
				NOT = {
					any_opinion_modifier_target = {
						count = 6
						has_opinion_modifier = { modifier = opinion_companion_TOJ who = ROOT }
					}
				}
			}
			top_liege = {
				random_realm_character = {
					limit = {
						NOT = { reverse_has_opinion_modifier = { modifier = opinion_coward_TOJ who = ROOT } }
						NOT = { has_opinion_modifier = { modifier = opinion_companion_TOJ who = ROOT } }
						is_female = no
						age = 16
						NOT = { age = 30 }
						prisoner = no
						is_ill = no
						has_epidemic = no
						NOT = { has_severe_disability_trigger = yes }
						OR = {
							trait = trained_warrior
							trait = skilled_warrior
							trait = master_warrior
						}
						opinion = { who = ROOT value = -10 }
						NOT = { dynasty = 0 }
						father_even_if_dead = { always = yes }
					}
					character_event = { id = tower_of_joy.2 }
				}
			}	
		}		
	}
	
	option = {
		name = OK
	}	
}	
#Find new companion
character_event = {
	id = tower_of_joy.2
	desc = "EVTDESCtower_of_joy.2"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.2" #I will fight for Lyanna
		ai_chance = { 	
			factor = 50
			
			modifier = { 
				factor = 4
				is_close_relative = FROM
			}
			modifier = { 
				factor = 2
				opinion = { who = FROM value = 20 }
			}
			modifier = { 
				factor = 1.5
				opinion = { who = FROM value = 40 }
			}
			modifier = { 
				factor = 1.5
				opinion = { who = FROM value = 60 }
			}
			modifier = { 
				factor = 1.5
				opinion = { who = FROM value = 80 }
			}
			modifier = { 
				factor = 2
				trait = honorable
			}
			modifier = { 
				factor = 2
				trait = brave
			}
			modifier = { 
				factor = 2
				trait = just
			}	 
		}
		set_character_flag = tower_of_joy
		set_character_flag = TOJ_companion
		FROM = {
			opinion = {
				modifier = opinion_companion_TOJ
				who = ROOT
				years = 100
			}
			hidden_tooltip = { character_event = { id = tower_of_joy.299 } }
		}
	}
	option = {
		name = "EVTOPTBtower_of_joy.2" #No
		ai_chance = { 	
			factor = 50 
			modifier = { 
				factor = 0
				has_character_flag = TOJ_companion
			}
			modifier = { 
				factor = 2
				trait = craven
			}
			modifier = { 
				factor = 2
				trait = arbitrary
			}
		}
		prestige = -30
		FROM = {
			opinion = {
				modifier = opinion_coward_TOJ
				who = ROOT
				years = 10
			}
		}
	}
}
character_event = { #Inform new companion
	id = tower_of_joy.299
	desc = "EVTDESCtower_of_joy.299"
	
	is_triggered_only = yes

	option = {
		name = "EVTOPTAtower_of_joy.299"
		hidden_tooltip = {
			FROM = {
				remove_title = job_chancellor	
				remove_title = job_treasurer
				remove_title = job_marshal	
				remove_title = job_spymaster
				remove_title = job_castellan
			}
		}
		reverse_opinion = {
			modifier = opinion_companion_TOJ
			who = FROM
			years = 100
		}
		location = {
			ROOT = {
				spawn_unit = {
					province = PREV
					leader = FROM
					owner = ROOT
					troops = {
						archers = { 10 10 }
						heavy_infantry = { 32 32 }
						light_infantry = { 44 44 }	
						light_cavalry = { 8 8 }		
						knights = { 6 6 }						
					}
					attrition = 1.0
					disband_on_peace = yes
				}
			}	
		}
	}
}
#TOJ kingsguard
character_event = {
	id = tower_of_joy.3
	desc = "EVTDESCtower_of_joy.3"
	
	is_triggered_only = yes

	option = {
		name = "EVTOPTAtower_of_joy.3" #
		set_character_flag = tower_of_joy
		set_character_flag = TOJ_kingsguard
		add_trait = wikid
	}
}

####The Tower of Joy####
character_event = {
	id = tower_of_joy.599
	
	is_triggered_only = yes	
	hide_window = yes
	
	immediate = {	
		#Check if journey to TOJ can proceed
		if = {
			limit = {
				c_4059 = { #Lyanna
					is_alive = yes
				}
				NOT = { has_global_flag = TOJ_resolved }
			}
			c_4059 = { set_character_flag = tower_of_joy }
			random_character = { 
				limit = {
					has_character_flag = TOJ_leader				
					dynasty = 59
					NOT = { has_global_flag = TOJ_resolved }
					is_alive = yes
					age = 15
					NOT = { trait = incapable }
					NOT = { has_character_flag = tower_of_joy }
				}	
				narrative_event = { id = tower_of_joy.5 }
				break = yes
			}
			if = { 
				limit = {			
					has_landed_title = k_north
					is_alive = yes
					age = 15
					NOT = { trait = incapable }
					any_sibling = {
						character = 4059
						is_alive = yes
					}
					NOT = { has_character_flag = tower_of_joy }
				}
				narrative_event = { id = tower_of_joy.5 }
				break = yes
			}
			random_character = { 
				limit = {
					dynasty = 59
					is_alive = yes
					
					NOT = { has_global_flag = TOJ_resolved }
					age = 15
					NOT = { trait = incapable }
					any_sibling = {
						character = 4059
						is_alive = yes
					}
					NOT = { has_character_flag = tower_of_joy }
				}
				narrative_event = { id = tower_of_joy.5 }
				break = yes
			}
			random_character = { 
				limit = {
					dynasty = 59
					is_alive = yes
					
					NOT = { has_global_flag = TOJ_resolved }
					age = 15
					NOT = { trait = incapable }
					NOT = { has_character_flag = tower_of_joy }
				}
				narrative_event = { id = tower_of_joy.5 }
				break = yes
			}
		}
		
		
		#If not, resolve
		set_global_flag = TOJ_resolved
		#Remove Quest traits from kingsguard
		kingsguard = {
			limit = {
				is_alive = yes
				trait = wikid
				has_character_flag = TOJ_kingsguard
			}	
			remove_trait = wikid
			clr_character_flag = TOJ_kingsguard
		}	
		kingsguard = {
			limit = {
				is_alive = yes
				trait = wikid
				has_character_flag = TOJ_kingsguard
			}	
			remove_trait = wikid
			clr_character_flag = TOJ_kingsguard
		}
		kingsguard = {
			limit = {
				is_alive = yes
				trait = wikid
				has_character_flag = TOJ_kingsguard
			}	
			remove_trait = wikid
			clr_character_flag = TOJ_kingsguard
		}
		random_list = {
			25 = { #Lyanna Lives
				c_4059 = { #Lyanna
					random_dynasty_member = { 
						limit = { 
							is_alive = yes 
							OR = {
								demesne_size = 1
								NOT = { liege = { dynasty = 496 } }
							}
						}
						if = {
							limit = { demesne_size = 1 }
							reverse_banish = PREV
						} 
						if = {
							limit = { NOT = { demesne_size = 1 } }
							liege = { reverse_banish = PREVPREV }
						}
					}
					prisoner = no 
					any_lover = { remove_lover = PREV }
					remove_trait = has_missing	
					remove_character_modifier = child
				}
			} 
			25 = { #Lyanna Dies
				c_4059 = { #Lyanna
					death = { death_reason = death_missing }
				}
			} 
		}
	}
}	
narrative_event = {
	id = tower_of_joy.5
	title = "EVTNAMEtower_of_joy.5"
	desc = "EVTDESCtower_of_joy.5"
	picture = "GFX_tower_of_joy"
	border = "GFX_event_narrative_frame_religion"
	
	is_triggered_only = yes
	hide_from = yes
	
	immediate = {	
		set_character_flag = tower_of_joy
		set_character_flag = do_not_disturb
		c_4059 = { set_character_flag = tower_of_joy }
		add_trait = kingsguard_protection_target #to track in case of death in duel
		
		#if less than 6 companions create random
		if = {
			limit = {
				NOT = {
					any_opinion_modifier_target = {
						count = 6
						has_opinion_modifier = { modifier = opinion_companion_TOJ who = ROOT }
					}
				}
			}
			create_random_soldier = {
				random_traits = yes
				dynasty = none
				female = no
				religion = ROOT
				culture = ROOT
				historical = yes
			}
			new_character = {
				remove_trait = weak
				remove_trait = imbecile
				remove_trait = dwarf
				remove_trait = clubfooted
				remove_trait = hunchback
				remove_trait = inbred
				remove_trait = craven
				random_list = {
					100 = { add_trait = trained_warrior }
					20 = { add_trait = skilled_warrior }
					5 = { add_trait = master_warrior }
				}
				random_list = {
					40 = { }
					10 = { add_trait = strong }
					10 = { add_trait = tall }
					10 = { add_trait = brave }
					10 = { remove_trait = slow add_trait = quick }
				}
				if = {
					limit = { religion = the_seven }
					knight_character_effect = yes
				}				
			}
			new_character = {
				set_character_flag = TOJ_companion  
				character_event = { id = tower_of_joy.2 }
			}
		}
	}

	option = {
		name = "EVTOPTAtower_of_joy.5" 
		#Display Combatants
		any_realm_character = {
			limit = {
				has_character_flag = TOJ_companion  
				has_opinion_modifier = { modifier = opinion_companion_TOJ who = ROOT }
			}
			set_character_flag = do_not_disturb
			custom_tooltip = { text = TOOLTIPTOJCOMPANION }
		}
		e_iron_throne = {
			holder_scope = {
				any_realm_character = {
					limit = { 
						trait = kingsguard
						trait = wikid
						has_character_flag = TOJ_kingsguard 
					}
					set_character_flag = do_not_disturb
					custom_tooltip = { text = TOOLTIPTOJKINGSGUARD }
				}
			}
		}	
		#Start some Duels
		hidden_tooltip = {
			character_event = { id = tower_of_joy.699 days = 6 } #duel management
			
			random_opinion_modifier_target = { 	
				limit = { 
					has_character_flag = TOJ_companion  
					has_opinion_modifier = { modifier = opinion_companion_TOJ who = ROOT }
				}
				set_character_flag = duel_started
				character_event = { id = tower_of_joy.6 days = 1 }
			}
			random_opinion_modifier_target = { 	
				limit = { 
					has_character_flag = TOJ_companion  
					has_opinion_modifier = { modifier = opinion_companion_TOJ who = ROOT }
					NOT = { has_character_flag = duel_started }
				}
				set_character_flag = duel_started
				character_event = { id = tower_of_joy.6 days = 3 }
			}
			random_opinion_modifier_target = { 	
				limit = { 
					has_character_flag = TOJ_companion  
					has_opinion_modifier = { modifier = opinion_companion_TOJ who = ROOT }
					NOT = { has_character_flag = duel_started }
				}
				character_event = { id = tower_of_joy.6 days = 5 }
			}			
			random = { chance = 50 set_character_flag = lyanna_lives } #50% chance Lyanna dies
			if = {
				limit = { has_game_rule = { name = r_l_j value = on } }#R+L=J - always has a child					
				set_character_flag = lyanna_son 
			}
		}		
	}
}

#Duel Management Event
character_event = {
	id = tower_of_joy.699

	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		NOT = { has_global_flag = TOJ_resolved }
		has_character_flag = tower_of_joy
		trait = kingsguard_protection_target
	}
	
	immediate = {		
		#If kingsguard have gone missing, resolve
		if = {
			limit = {
				NOT = { has_global_flag = TOJ_resolved }
				NOT = {
					kingsguard = {
						is_alive = yes
						trait = wikid
						has_character_flag = TOJ_kingsguard
					}
				}
			}
			character_event = { id = tower_of_joy.8 days = 3 }
			break = yes
		}	
		character_event = { id = tower_of_joy.699 days = 3 } #re-iterate
		if = { #If only 3 companions left, may go into duel
			limit = { 
				NOT = { 
					any_opinion_modifier_target = {
						count = 4
						has_character_flag = TOJ_companion  
						has_opinion_modifier = { modifier = opinion_companion_TOJ who = ROOT }
						is_alive = yes
					}
				} 
				OR = {
					NOT = { has_character_flag = TOJ_duel_ned }
					had_character_flag = { flag = TOJ_duel_ned days = 10 } #failsafe
				}
			}
			random = {
				chance = 50
				character_event = { id = tower_of_joy.6 }
				break = yes
			}
		}
		#Then pick companion
		random_opinion_modifier_target = { 	
			limit = { 
				has_character_flag = TOJ_companion  
				has_opinion_modifier = { modifier = opinion_companion_TOJ who = ROOT }
				OR = {
					NOT = { has_character_flag = TOJ_duel_ned }
					had_character_flag = { flag = TOJ_duel_ned days = 10 } #failsafe
				}
			}
			character_event = { id = tower_of_joy.6 }				
			break = yes
		}
		#Last man standing
		character_event = { id = tower_of_joy.6 }		
	}
	
	option = {
		name = OK
	}
}

#New duel
character_event = {
	id = tower_of_joy.6
	picture = "GFX_TOJ_kingsguard"
	title = "EVTNAMEtower_of_joy.5"
		
	desc = {
		text = "EVTDESCtower_of_joy.6"
		trigger = { NOT = { character = FROM } }
	}
	desc = {
		text = "EVTDESCtower_of_joy.6B"
		trigger = { character = FROM }
	}	
	
	is_triggered_only = yes
	
	trigger = {
		FROM = { is_alive = yes }
		is_alive = yes
		NOT = { has_global_flag = TOJ_resolved }
		OR = {
			NOT = { has_character_flag = TOJ_duel_ned }
			had_character_flag = { flag = TOJ_duel_ned days = 10 } #failsafe
		}	
		kingsguard = {
			is_alive = yes
			trait = wikid
			has_character_flag = TOJ_kingsguard
			OR = {
				NOT = { has_character_flag = TOJ_duel_KG }
				had_character_flag = { flag = TOJ_duel_KG days = 10 } #failsafe
			}
			NOT = { has_character_flag = TOJ_duel_me }
		}
	}
		
	immediate = {
		kingsguard = {
			limit = {
				is_alive = yes
				trait = wikid
				has_character_flag = TOJ_kingsguard
				OR = {
					NOT = { has_character_flag = TOJ_duel_KG }
					had_character_flag = { flag = TOJ_duel_KG days = 10 } #failsafe
				}
				NOT = { has_character_flag = TOJ_duel_me }
			}
			save_event_target_as = duel_me_kingsuard
		}
	}
	
	option = {
		name = "EVTOPTAtower_of_joy.6" 
		clr_character_flag = TOJ_duel_ned
		set_character_flag = TOJ_duel_ned
		set_character_flag = flag_duel_to_the_death
		clr_character_flag = duel_started
		event_target:duel_me_kingsuard = {
			clr_character_flag = TOJ_duel_KG
			set_character_flag = TOJ_duel_KG
			set_character_flag = flag_duel_to_the_death
			character_event = { id = tower_of_joy.7  tooltip = "EVTTOOLTIPtower_of_joy.7" }
		}
		clear_event_target = duel_me_kingsuard
	}
}
#Kingsguard in duel
character_event = {
	id = tower_of_joy.7
	picture = "GFX_tower_of_joy"
	title = "EVTNAMEtower_of_joy.5"
	desc = "EVTDESCtower_of_joy.7"
	
	is_triggered_only = yes
	
	trigger = { 
		is_alive = yes
		FROM = { is_alive = yes } 
	}
	
	option = {
		name = "EVTOPTAtower_of_joy.7" 	
		hidden_tooltip = {
			e_rebels = { holder_scope = { character_event = { id = duel.0 } } } ##duel engine started
		}	
	}
}

#Inform ned of companion victory
character_event = {
	id = tower_of_joy.8
	picture = "GFX_evt_melee"
	title = "EVTNAMEtower_of_joy.5"
	desc = "EVTDESCtower_of_joy.8"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.8" 
		FROM = { prestige = 20 }
		FROM = { FROM = { prestige = -20 } }
		
		#Check if Kingsguard has been defeated
		if = {
			limit = {
				NOT = { has_global_flag = TOJ_resolved }
				NOT = {
					kingsguard = {
						is_alive = yes
						trait = wikid
						has_character_flag = TOJ_kingsguard
					}
				}
			}
			hidden_tooltip = { 
				remove_trait = kingsguard_protection_target 
				clr_character_flag = do_not_disturb
				add_trait = assign_mission_target
				set_character_flag = ToJ_survivor
			}
			#Determine outcome
			if = {
				limit = { has_character_flag = lyanna_lives	}
				if = {
					limit = { has_character_flag = lyanna_son }
					character_event = { id = tower_of_joy.10 tooltip = "EVTTOOLTIPtower_of_joy.10" }
				}	
				if = {
					limit = { NOT = { has_character_flag = lyanna_son } }
					character_event = { id = tower_of_joy.12 tooltip = "EVTTOOLTIPtower_of_joy.10" }
				}
			}
			if = {
				limit = { NOT = { has_character_flag = lyanna_lives	} }
				if = {
					limit = { has_character_flag = lyanna_son }
					character_event = { id = tower_of_joy.11 tooltip = "EVTTOOLTIPtower_of_joy.10" }
				}	
				if = {
					limit = { NOT = { has_character_flag = lyanna_son } }
					character_event = { id = tower_of_joy.13 tooltip = "EVTTOOLTIPtower_of_joy.10" }
				}
			}	
			#Inform/befriend companions
			any_opinion_modifier_target = {
				limit = { 
					has_character_flag = TOJ_companion  
					has_opinion_modifier = { modifier = opinion_companion_TOJ who = ROOT }
					is_alive = yes
				}
				hidden_tooltip = { character_event = { id = tower_of_joy.999 } }		
				add_friend = ROOT
			}
			break = yes
		}	
	}
}

#Inform ned of KG victory
character_event = {
	id = tower_of_joy.9
	picture = "GFX_evt_melee"
	title = "EVTNAMEtower_of_joy.5"
	desc = "EVTDESCtower_of_joy.9"
	
	is_triggered_only = yes

	option = {
		name = "EVTOPTAtower_of_joy.8" 
		FROM = { prestige = 20 }
		FROM = { 
			FROM = { 
				prestige = -20 
			} 
		}
	}
}

#Inform companion the battle is won
character_event = {
	id = tower_of_joy.999
	picture = "GFX_tower_of_joy"
	title = "EVTNAMEtower_of_joy.5"
	desc = "EVTDESCtower_of_joy.999"
	
	is_triggered_only = yes

	option = {
		name = "EVTOPTAtower_of_joy.999" 
		add_friend = FROM
		clr_character_flag = TOJ_companion 
		clr_character_flag = do_not_disturb
		hidden_tooltip = {
			add_trait = assign_mission_target
			set_character_flag = ToJ_survivor
		}
	}
}

#Ned wins aftermath- Lyanna Lives, has baby
character_event = {
	id = tower_of_joy.10
	title = "EVTNAMEtower_of_joy.5"
	picture = "GFX_tower_of_joy"
	desc = "EVTDESCtower_of_joy.10SUBMOD"

	is_triggered_only = yes
	
	immediate = {
		set_global_flag = TOJ_resolved
	}
	
	option = {
		name = "EVTOPTAtower_of_joy.10" #take home baby as Lyanna's
		c_4059 = {
			if = {
				limit = {
					spouse = { character = 317 }
				}
				e_iron_throne = {
					holder_scope = {
						reverse_banish = PREVPREV
						opinion = {
							modifier = opinion_angry
							who = ROOT
							years = 5
						}
						hidden_tooltip = { character_event = { id = tower_of_joy.15 } }
					}
				}
			}
			if = {
				limit = {
					NOT = { spouse = { character = 317 } }
				}
				move_character = ROOT
			}
			create_character = {
				name = ִזמם
				female = no
				age = 0
				dna="decfbzliecd"
				properties="0t00i"
				historical = yes
			}
			new_character = {
				set_mother = PREV
				dynasty = PREV
				add_trait = bastard
				give_nickname = nick_sand
				move_character = ROOT
				set_character_flag = targaryen_dynasty
				character_event = { id = tower_of_joy.14 }
			}
			prisoner = no
			remove_trait = has_missing
			hidden_tooltip = { remove_character_modifier = child }
			opinion = {
				modifier = opinion_very_grateful
				who = ROOT
				years = 15
			}	
		}
	}
	option = {
		name = "EVTOPTBtower_of_joy.10SUBMOD" #assume as own bastard
		c_4059 = {
			if = {
				limit = {
					spouse = { character = 317 }
				}
				e_iron_throne = {
					holder_scope = {
						reverse_banish = PREVPREV
						hidden_tooltip = { character_event = { id = tower_of_joy.16 } }
					}
				}
			}
			if = {
				limit = {
					NOT = { spouse = { character = 317 } }
				}
				move_character = ROOT
			}
			prisoner = no
			opinion = {
				modifier = opinion_upset
				who = ROOT
				years = 15
			}
			remove_trait = has_missing
			hidden_tooltip = { remove_character_modifier = child }
			hidden_tooltip = {
				add_trait = assign_mission_target
				set_character_flag = ToJ_survivor
			}
		}
		create_character = {
			name = ִזמם
			female = no
			age = 0
			dna="decfbzliecd"
			properties="0t00i"
			historical = yes
		}
		new_character = {
			set_father = PREV
			dynasty = PREV
			add_trait = bastard
			give_nickname = nick_snow
			set_character_flag = jon_snow
			character_event = { id = tower_of_joy.1499 }
		}
		spouse = {
			character_event = { id = 76101 tooltip = "EVTTOOLTIP76101" } # The wife is angered
		}	
	}
}

#Ned wins aftermath- Lyanna Dies, has baby
character_event = {
	id = tower_of_joy.11
	title = "EVTNAMEtower_of_joy.5"
	picture = "GFX_tower_of_joy"
	desc = "EVTDESCtower_of_joy.11SUBMOD"
	desc = "EVTDESCtower_of_joy.11"

	is_triggered_only = yes
	
	immediate = {
		set_global_flag = TOJ_resolved
	}
	
	option = {
		name = "EVTOPTAtower_of_joy.10" #take home baby as Lyanna's
		c_4059 = {
			if = {
				limit = {
					spouse = { character = 317 }
				}
				e_iron_throne = {
					holder_scope = {
						opinion = {
							modifier = opinion_angry
							who = ROOT
							years = 5
						}
						hidden_tooltip = { character_event = { id = tower_of_joy.17 } }
					}	
				}
			}
			create_character = {
				name = ִזמם
				female = no
				age = 0
				dna="decfbzliecd"
				properties="0t00i"
				historical = yes
			}
			new_character = {
				set_mother = PREV
				dynasty = PREV
				add_trait = bastard
				give_nickname = nick_sand
				set_character_flag = targaryen_dynasty
				character_event = { id = tower_of_joy.14 }
				move_character = ROOT
			}
			remove_trait = has_missing
			hidden_tooltip = { 
				prisoner = no 
			}
			death = { death_reason = death_childbirth }
		}
		random = {
			chance = 15
			add_trait = depressed
			hidden_tooltip = {
				character_event = {
					id = 38288 #Notify Depressed
				}
			}
		}	
	}
	option = {
		name = "EVTOPTBtower_of_joy.11SUBMOD" #assume as own bastard
		c_4059 = {
			remove_trait = has_missing
			hidden_tooltip = { prisoner = no }
			death = { death_reason = death_childbirth }
		}
		create_character = {
			name = ִזמם
			female = no
			age = 0
			dna="decfbzliecd"
			properties="0t00i"
			historical = yes
		}
		new_character = {
			set_father = PREV
			dynasty = PREV
			add_trait = bastard
			give_nickname = nick_snow
			set_character_flag = jon_snow
			character_event = { id = tower_of_joy.1499 }
		}
		random = {
			chance = 15
			add_trait = depressed
			hidden_tooltip = {
				character_event = {
					id = 38288 #Notify Depressed
				}
			}
		}	
		spouse = {
			character_event = { id = 76101 tooltip = "EVTTOOLTIP76101" } # The wife is angered
		}
		# hidden_tooltip = {
			# e_iron_throne = {
				# holder_scope = {
					# character_event = { id = tower_of_joy.18 }
				# }
			# }
		# }	
	}

}

#Lyanna Lives, does not have baby
character_event = {
	id = tower_of_joy.12
	title = "EVTNAMEtower_of_joy.5"
	picture = "GFX_tower_of_joy"
	desc = "EVTDESCtower_of_joy.12"
	
	is_triggered_only = yes
	
	immediate = {
		set_global_flag = TOJ_resolved
	}
	
	option = {
		name = "EVTOPTAtower_of_joy.12" #yay!
		c_4059 = {
			if = {
				limit = {
					spouse = { character = 317 }
				}
				e_iron_throne = {
					holder_scope = {
						reverse_banish = PREVPREV
					}
				}
			}
			if = {
				limit = {
					NOT = { spouse = { character = 317 } }
				}
				move_character = ROOT
			}
			prisoner = no
			opinion = {
				modifier = opinion_very_grateful
				who = ROOT
				years = 15
			}
			remove_trait = has_missing
			hidden_tooltip = { remove_character_modifier = child }
		}
		hidden_tooltip = {
			e_iron_throne = {
				holder_scope = {
					character_event = { id = tower_of_joy.16 }
				}
			}
			if = {
				limit = { has_game_rule = { name = r_l_j value = off } }
				random = {
					chance = 50
					character_event = { id = tower_of_joy.20 days = 25 }  #non spoiler bastard event
				}
			}	
		}
	}
}

#Ned wins aftermath- Lyanna Dies, does not have baby
character_event = {
	id = tower_of_joy.13
	title = "EVTNAMEtower_of_joy.5"
	picture = "GFX_tower_of_joy"
	desc = "EVTDESCtower_of_joy.13"
	
	is_triggered_only = yes
	
	immediate = {
		set_global_flag = TOJ_resolved
	}
	
	option = {
		name = "EVTOPTAtower_of_joy.13" #oh dear
		c_4059 = {
			hidden_tooltip = { 
				prisoner = no 
				remove_trait = has_missing
			}
			death = yes
		}
		random = {
			chance = 15
			add_trait = depressed
			hidden_tooltip = {
				character_event = {
					id = 38288 #Notify Depressed
				}
			}
		}	
		hidden_tooltip = {
			e_iron_throne = {
				holder_scope = {
					character_event = { id = tower_of_joy.18 }
				}
			}
			if = {
				limit = { has_game_rule = { name = r_l_j value = off } }
				random = {
					chance = 50
					character_event = { id = tower_of_joy.20 days = 25 }  #non spoiler bastard event
				}
			}
		}
	}

}

#Set jon's father
character_event = {
	id = tower_of_joy.14
	title = "EVTNAMEtower_of_joy.5"
	picture = "GFX_tower_of_joy"
	desc = "EVTDESCtower_of_joy.14"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.14" #oh dear	
		if = {
			limit = { has_character_flag = targaryen_dynasty }
			e_iron_throne = { add_claim = ROOT }
			d_kings_landing = { add_claim = ROOT }
			c_kings_landing = { add_claim = ROOT }
			set_character_flag = exiled_royal_family
			c_77039 = { #Rhaegar
				ROOT = { dynasty = PREV }
			}
			clr_character_flag = targaryen_dynasty
		}
		c_77039 = { #Rhaegar
			ROOT = { set_father = PREV }
			remove_trait = assign_mission_target
		}
	}
}

#secretly set jon father as rhaegar
character_event = {
	id = tower_of_joy.1499

	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		c_77039 = { #Rhaegar
			ROOT = { set_real_father = PREV }
			remove_trait = assign_mission_target
		}
	}
	
	option = {
		name = OK	
	}
}

#Roberts reactions
#lyanna lives, bastard acknowledged
character_event = {
	id = tower_of_joy.15
	title = "EVTNAMEtower_of_joy.5"
	picture = "GFX_tower_of_joy"
	desc = "EVTDESCtower_of_joy.15"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.15" #disappointing
		ai_chance = { factor = 85 }
		if = {
			limit = {
				spouse = { character = 4059  }
			}
			spouse = {
				reverse_opinion = {
					modifier = opinion_angry 
					who = ROOT
					years = 10
				}
			}
		}
	}
	
	option = {
		name = "EVTOPTBtower_of_joy.15" #divorce!
		ai_chance = { factor = 15 }
		trigger = { spouse = { character = 4059  } }
		if = {
			limit = {
				spouse = { character = 4059  }
			}
			spouse = {
				reverse_opinion = {
					modifier = opinion_angry 
					who = ROOT
					years = 10
				}
			}
			remove_spouse = spouse
			k_north = {
				holder_scope = {
					reverse_opinion = {
						modifier = opinion_very_disappointed
						who = ROOT
						years = 10
					}
				}
			}
			hidden_tooltip = {
				FROM = { letter_event = { id = tower_of_joy.23 } }
			}
		}
	}

}

#lyanna lives!
character_event = {
	id = tower_of_joy.16
	title = "EVTNAMEtower_of_joy.5"
	picture = "GFX_tower_of_joy"
	desc = "EVTDESCtower_of_joy.16"
	
	trigger = { 
		character = 317
	}
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.16" #
		add_character_modifier = {
			name = "wedding"
			duration = 60
		}
	}
}

#lyanna dies, bastard acknowledged
character_event = {
	id = tower_of_joy.17
	title = "EVTNAMEtower_of_joy.5"
	picture = "GFX_tower_of_joy"
	desc = "EVTDESCtower_of_joy.17"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.17" #
		trigger = { character = 317 }
		random = {
			chance = 15
			add_trait = depressed
			hidden_tooltip = {
				character_event = {
					id = 38288 #Notify Depressed
				}
			}
		}	
	}
	
	option = {
		name = "EVTOPTBtower_of_joy.17" #
		trigger = { NOT = { character = 317 } }
	}
}

#lyanna dies
character_event = {
	id = tower_of_joy.18
	title = "EVTNAMEtower_of_joy.5"
	picture = "GFX_tower_of_joy"
	desc = "EVTDESCtower_of_joy.18"
	
	trigger = { 
		character = 317
	}
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.17" #
		random = {
			chance = 15
			add_trait = depressed
			hidden_tooltip = {
				character_event = {
					id = 38288 #Notify Depressed
				}
			}
		}	
	}
}

#Kingsguard win aftermath, Lyanna lives, no baby
character_event = {
	id = tower_of_joy.19
	title = "EVTNAMEtower_of_joy.5"
	picture = "GFX_tower_of_joy"
	desc = "EVTDESCtower_of_joy.19"

	is_triggered_only = yes
	
	immediate = {
		set_global_flag = TOJ_resolved
	}
	
	option = {
		name = "EVTOPTAtower_of_joy.19" #take home baby as Lyanna's
		c_4059 = {
			if = {
				limit = {
					spouse = { character = 317 }
				}
				e_iron_throne = {
					holder_scope = {
						hidden_tooltip = { character_event = { id = tower_of_joy.21 } }
					}
				}
			}
			remove_trait = has_missing
			hidden_tooltip = { remove_character_modifier = child }
			character_event = { id = tower_of_joy.22 } #to pentos!
			if = {
				limit = { has_game_rule = { name = r_l_j value = on } }
				create_character = {
					name = ילמם
					culture = northman
					female = no
					age = 0
					dna="decfbzliecd"
					properties="0t00i"
					historical = yes
				}
				new_character = {
					set_mother = PREV
					dynasty = PREV
					#give_nickname = nick_sand
					set_character_flag = targaryen_dynasty
					character_event = { id = tower_of_joy.14 days = 1 }
					character_event = { id = tower_of_joy.22 } #to pentos!
				}
			}	
		}
		remove_trait = kingsguard
		clr_character_flag = no_court_invites
		remove_trait = wikid
		clr_character_flag = TOJ_kingsguard
		character_event = { id = tower_of_joy.22 } #to pentos!		
		kingsguard = {
			limit = {
				is_alive = yes
				trait = wikid
				has_character_flag = TOJ_kingsguard
				NOT = { character = ROOT }
			}	
			remove_trait = kingsguard
			clr_character_flag = no_court_invites
			remove_trait = wikid
			clr_character_flag = TOJ_kingsguard
			character_event = { id = tower_of_joy.22 } #to pentos!	
		}	
		kingsguard = {
			limit = {
				is_alive = yes
				trait = wikid
				has_character_flag = TOJ_kingsguard
				NOT = { character = ROOT }
			}	
			remove_trait = kingsguard
			clr_character_flag = no_court_invites
			remove_trait = wikid
			clr_character_flag = TOJ_kingsguard
			character_event = { id = tower_of_joy.22 } #to pentos!	
		}
		d_kingsguard = {
			holder_scope = {
				hidden_tooltip = { #Universal on death/abdication event
					if = {
						limit = { any_artifact = { has_artifact_flag = valyrian_steel } }
						set_character_flag = do_not_inherit_sword
					}
					set_character_flag = abdication
					character_event = { id = 45341 } 
					clr_character_flag = abdication
					clr_character_flag = do_not_inherit_sword
				}
				if = {
					limit = { NOT = { trait = kingsguard } }
					recalc_succession = yes
					d_kingsguard_dummy = { copy_title_history = d_kingsguard }
					abdicate = yes					
					set_global_flag = need_commander_kingsguard
					set_global_flag = change_kingsguard_history
				}
			}
		}
	}
}

#Non spoiler, ned brings bastard home event
character_event = {
	id = tower_of_joy.20
	desc = "EVTDESCtower_of_joy.20"

	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.20" #
		create_character = {
			name = ִזמם
			female = no
			age = 0
			dna="decfbzliecd"
			properties="0t00i"
			historical = yes
		}
		new_character = {
			set_father = PREV
			dynasty = PREV
			add_trait = bastard
			give_nickname = nick_snow
		}
		spouse = {
			character_event = { id = 76101 tooltip = "EVTTOOLTIP308" } # The wife is angered
		}
	}
}
#Inform robert of Kingsguard victory
character_event = {
	id = tower_of_joy.21
	title = "EVTNAMEtower_of_joy.5"
	picture = "GFX_tower_of_joy"
	desc = "EVTDESCtower_of_joy.21"

	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.21" #
		c_4059 = { remove_spouse = ROOT }
		random = {
			chance = 25
			add_trait = depressed
			hidden_tooltip = {
				character_event = {
					id = 38288 #Notify Depressed
				}
			}
		}	
	}
}
#To Pentos!
character_event = {
	id = tower_of_joy.22
	desc = "EVTDESCtower_of_joy.22"

	is_triggered_only = yes
	
	immediate = {
		k_pentos = {
			holder_scope = {
				ROOT = { move_character = PREV }
			}
		}
	}
	
	option = {
		name = "EVTOPTAtower_of_joy.22" #
		tooltip = {
			k_pentos = {
				holder_scope = {
					ROOT = { move_character = PREV }
				}
			}
		}	
	}
}
#Inform ned of divorce
letter_event = {
	id = tower_of_joy.23
	desc = "EVTDESCtower_of_joy.23"

	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.23" #
	}
}
# ###Tower of Joy- Rhaegar resolution###
character_event = {
	id = tower_of_joy.239
	
	is_triggered_only = yes	
	hide_window = yes
	
	immediate = {
		set_global_flag = TOJ_resolved
		#Remove Quest traits from kingsguard
		kingsguard = {
			limit = {
				is_alive = yes
				trait = wikid
				has_character_flag = TOJ_kingsguard
			}	
			remove_trait = wikid
			clr_character_flag = TOJ_kingsguard
		}	
		kingsguard = {
			limit = {
				is_alive = yes
				trait = wikid
				has_character_flag = TOJ_kingsguard
			}	
			remove_trait = wikid
			clr_character_flag = TOJ_kingsguard
		}
		kingsguard = {
			limit = {
				is_alive = yes
				trait = wikid
				has_character_flag = TOJ_kingsguard
			}	
			remove_trait = wikid
			clr_character_flag = TOJ_kingsguard
		}
		if = {
			limit = { has_game_rule = { name = r_l_j value = on } } #only give rhaegar event if R+L=J option is on
			c_77039 = { #Rhaegar
				if = {
					limit = {
						is_alive = yes
						prisoner = no
						is_incapable = no
					}
					narrative_event = { id = tower_of_joy.240 days = 4 }
					break = yes
				}	
			}
		}	
		random_list = {
			25 = { #Lyanna Lives
				c_4059 = {
					prisoner = no 				
					remove_trait = has_missing	
					remove_character_modifier = child
					c_77039 = { #Rhaegar
						if = {
							limit = {
								is_alive = yes
								is_ruler = yes
							}
							reverse_banish = PREV
							break = yes
						}	
					}
					random_dynasty_member = { 
						limit = { 
							is_alive = yes 
							OR = {
								demesne_size = 1
								NOT = { liege = { dynasty = 496 } }
							}
						}
						if = {
							limit = { demesne_size = 1 }
							reverse_banish = PREV
						} 
						if = {
							limit = { NOT = { demesne_size = 1 } }
							liege = { reverse_banish = PREVPREV }
						}
					}
					any_lover = { remove_lover = PREV }
				}
			} 
			25 = { #Lyanna Dies
				c_4059 = {
					death = { death_reason = death_missing }
				}
			} 
		}
	}
}	
# Choose outcome
narrative_event = {
	id = tower_of_joy.240
	title = "EVTNAMEtower_of_joy.5"
	desc = "EVTDESCtower_of_joy.240"
	picture = "GFX_tower_of_joy"
	border = "GFX_event_narrative_frame_religion"
	
	is_triggered_only = yes
	
	hide_from = yes
	
	immediate = {
		set_character_flag = tower_of_joy		
		remove_trait = assign_mission_target	
	}

	option = {
		name = "EVTOPTAtower_of_joy.240" # Oh well
		hidden_tooltip = {
			random_list = {
				25 = { narrative_event = { id = tower_of_joy.24 } } #Lyanna Lives, child
				25 = { narrative_event = { id = tower_of_joy.25 } } #Lyanna Lives, no child
				25 = { narrative_event = { id = tower_of_joy.26 } } #Lyanna Dies, child
				25 = { narrative_event = { id = tower_of_joy.27 } } #Lyanna Dies, no child
			}
		}
	}
}
# Lyanna lives, with child
narrative_event = {
	id = tower_of_joy.24
	title = "EVTNAMEtower_of_joy.5"
	desc = "EVTDESCtower_of_joy.24"
	picture = "GFX_tower_of_joy"
	border = "GFX_event_narrative_frame_religion"
	
	hide_from = yes
	
	is_triggered_only = yes
	
	trigger = {
		character = 77039 #Rhaegar
		c_4059 = { is_alive = yes }
	}

	immediate = {
		set_character_flag = tower_of_joy
		c_4059 = { #Lyanna
			prisoner = no
		}	
	}

	option = {
		name = "EVTOPTAtower_of_joy.24" # Disown her and baby, send home
		c_4059 = { #Lyanna
			random_dynasty_member = { 
				limit = { 
					is_alive = yes 
					OR = {
						demesne_size = 1
						NOT = { liege = { dynasty = 496 } }
					}
				}
				if = {
					limit = { demesne_size = 1 }
					reverse_banish = PREV
				} 
				if = {
					limit = { NOT = { demesne_size = 1 } }
					liege = { reverse_banish = PREVPREV }
				}
			}
			hidden_tooltip = { prisoner = no any_lover = { remove_lover = PREV } }
			opinion = {
				who = ROOT
				modifier = opinion_hate
				years = 25
			}
			custom_tooltip = { text = TOOLTIPTOJSENDHOME }
			hidden_tooltip = {
				create_character = {
					female = no
					age = 0
					dna="decfbzliecd"
					properties="0t00i"
					culture = northman
					historical = yes
				}
				new_character = {
					set_father = ROOT
					set_mother = PREV
					dynasty = PREV
					add_trait = bastard
					give_nickname = nick_snow
				}
			}	
			remove_trait = has_missing
			hidden_tooltip = { 		
				remove_character_modifier = child
				any_dynasty_member = {
					limit = { is_alive = yes }
					character_event = { id = tower_of_joy.32 }
				}
			}
		}
		piety = -100
		hidden_tooltip = { character_event = { id = tower_of_joy.28 } }
	}
	
	option = {
		name = "EVTOPTBtower_of_joy.24" # Disown her and baby, take prisoner
		c_4059 = { #Lyanna
			move_character = ROOT
			imprison = ROOT
			hidden_tooltip = {
				any_lover = { remove_lover = PREV }
				remove_character_modifier = the_dungeon
				add_character_modifier = { 
					name = house_arrest
					duration = -1
				}
			}
			opinion = {
				who = ROOT
				modifier = opinion_hate
				years = 25
			}
			custom_tooltip = { text = TOOLTIPTOJCHILDIMPRISON }
			hidden_tooltip = {
				create_character = {
					female = no
					age = 0
					dna="decfbzliecd"
					properties="0t00i"
					culture = northman
					historical = yes
				}
				new_character = {
					set_father = ROOT
					set_mother = PREV
					dynasty = PREV
					add_trait = bastard
					give_nickname = nick_snow
					imprison = ROOT
					remove_character_modifier = the_dungeon
					add_character_modifier = { 
						name = house_arrest
						duration = -1
					}
				}
			}	
			remove_trait = has_missing
			hidden_tooltip = { 	
				remove_character_modifier = child
				any_dynasty_member = {
					limit = { is_alive = yes }
					character_event = { id = tower_of_joy.33 }
				}
			}
		}
		piety = -150
		hidden_tooltip = { character_event = { id = tower_of_joy.29 } }
	}
	
	option = {
		name = "EVTOPTCtower_of_joy.24" # Take as mistress
		c_4059 = { #Lyanna
			move_character = ROOT
			add_lover = ROOT
			custom_tooltip = { text = TOOLTIPTOJACKNOWLEDGE }
			hidden_tooltip = {
				create_character = {
					name = ילמם
					female = no
					age = 0
					dna="decfbzliecd"
					properties="0t00i"
					culture = northman
					historical = yes
				}
				new_character = {
					culture = high_valyrian
					set_father = ROOT
					set_mother = PREV
					dynasty = ROOT
					add_trait = bastard
					give_nickname = nick_waters
					random = {
						chance = 50
						character_event = { id = high_valyrian.3 days = 2000 }
					}	
				}
			}	
			remove_trait = has_missing
			hidden_tooltip = { 	
				remove_character_modifier = child
				any_dynasty_member = {
					limit = { is_alive = yes }
					character_event = { id = tower_of_joy.34 }
				}
			}
		}
		spouse = {
			opinion = {
				who = root
				modifier = acknowledged_bastard
				years = 10
			}
			k_dorne = {
				holder_scope = {
					opinion = {
						who = root
						modifier = acknowledged_bastard
						years = 10
					}
					hidden_tooltip = { character_event = { id = tower_of_joy.36 } }
				}	
			}
		}
		hidden_tooltip = { character_event = { id = tower_of_joy.30 } }
	}
	
	option = {
		name = "EVTOPTDtower_of_joy.24" # True love
		spouse = {
			opinion = {
				who = root
				modifier = opinion_divorced
			}
			opinion = {
				who = ROOT
				modifier = legitimized_bastard
				years = 10
			}
			k_dorne = {
				holder_scope = {
					opinion = {
						who = root
						modifier = opinion_divorced_relative
					}
					opinion = {
						who = ROOT
						modifier = opinion_angry
						years = 10
					}
					hidden_tooltip = { character_event = { id = tower_of_joy.37 } }
				}	
			}
		}
		any_child = {
			limit = { NOT = { trait = bastard } }
			opinion = {
				who = ROOT
				modifier = legitimized_bastard
				months = 12
			}
		}
		remove_spouse = spouse
		c_4059 = { #Lyanna
			move_character = ROOT
			add_lover = ROOT
			add_spouse = ROOT
			custom_tooltip = { text = TOOLTIPTOJTRUEBORN }
			hidden_tooltip = {
				create_character = {
					name = ילמם
					female = no
					age = 0
					dna="decfbzliecd"
					properties="0t00i"
					culture = northman
					historical = yes
				}
				new_character = {
					culture = high_valyrian
					set_father = ROOT
					set_mother = PREV
					dynasty = ROOT
					random = {
						chance = 50
						character_event = { id = high_valyrian.3 days = 2000 }
					}
				}
			}
			remove_trait = has_missing			
			hidden_tooltip = { 	
				remove_character_modifier = child
				any_dynasty_member = {
					limit = { is_alive = yes }
					character_event = { id = tower_of_joy.35 }
				}
			}
		}
		add_character_modifier = {
			name = "wedding"
			duration = 60
		}
		hidden_tooltip = { character_event = { id = tower_of_joy.31 } }
	}
}
# Lyanna lives, no child
narrative_event = {
	id = tower_of_joy.25
	title = "EVTNAMEtower_of_joy.5"
	desc = "EVTDESCtower_of_joy.25"
	picture = "GFX_tower_of_joy"
	border = "GFX_event_narrative_frame_religion"
	
	is_triggered_only = yes
	
	hide_from = yes
	
	trigger = {
		character = 77039 #Rhaegar
		c_4059 = { is_alive = yes } #Lyanna
	}

	immediate = {
		set_character_flag = tower_of_joy
	}

	option = {
		name = "EVTOPTAtower_of_joy.25" # send home
		c_4059 = { #Lyanna
			random_dynasty_member = { 
				limit = { 
					is_alive = yes 
					OR = {
						demesne_size = 1
						NOT = { liege = { dynasty = 496 } }
					}
				}
				if = {
					limit = { demesne_size = 1 }
					reverse_banish = PREV
				} 
				if = {
					limit = { NOT = { demesne_size = 1 } }
					liege = { reverse_banish = PREVPREV }
				}
			}
			hidden_tooltip = { prisoner = no any_lover = { remove_lover = PREV } }
			opinion = {
				who = ROOT
				modifier = opinion_hate
				years = 25
			}
			remove_trait = has_missing
			hidden_tooltip = { 	
				remove_character_modifier = child
				any_dynasty_member = {
					limit = { is_alive = yes }
					character_event = { id = tower_of_joy.32 }
				}
			}
		}
		piety = -100
		hidden_tooltip = { character_event = { id = tower_of_joy.28 } }
	}
	
	option = {
		name = "EVTOPTBtower_of_joy.25" # Take prisoner
		c_4059 = { #Lyanna
			move_character = ROOT
			imprison = ROOT
			hidden_tooltip = {
				any_lover = { remove_lover = PREV }
				remove_character_modifier = the_dungeon
				add_character_modifier = { 
					name = house_arrest
					duration = -1
				}
			}
			opinion = {
				who = ROOT
				modifier = opinion_hate
				years = 25
			}
			remove_trait = has_missing
			hidden_tooltip = { 
				remove_character_modifier = child
				any_dynasty_member = {
					limit = { is_alive = yes }
					character_event = { id = tower_of_joy.33 }
				}
			}
		}
		piety = -150
		hidden_tooltip = { character_event = { id = tower_of_joy.29 } }
	}
	
	option = {
		name = "EVTOPTCtower_of_joy.25" # Take as mistress
		c_4059 = { #Lyanna
			move_character = ROOT
			add_lover = ROOT
			remove_trait = has_missing
			hidden_tooltip = { 
				remove_character_modifier = child
				any_dynasty_member = {
					limit = { is_alive = yes }
					character_event = { id = tower_of_joy.34 }
				}
			}
		}
		spouse = {
			opinion = {
				who = root
				modifier = opinion_unfaithful_private
			}
			k_dorne = {
				holder_scope = {
					hidden_tooltip = { character_event = { id = tower_of_joy.36 } }
				}	
			}
		}
		hidden_tooltip = { character_event = { id = tower_of_joy.30 } }
	}
	
	option = {
		name = "EVTOPTDtower_of_joy.24" # True love
		spouse = {
			opinion = {
				who = root
				modifier = opinion_divorced
			}
			k_dorne = {
				holder_scope = {
					opinion = {
						who = root
						modifier = opinion_divorced_relative
					}
					opinion = {
						who = ROOT
						modifier = opinion_angry
						years = 10
					}
					hidden_tooltip = { character_event = { id = tower_of_joy.37 } }
				}	
			}
		}
		remove_spouse = spouse
		c_4059 = { #Lyanna
			move_character = ROOT
			add_lover = ROOT
			add_spouse = ROOT
			remove_trait = has_missing
			hidden_tooltip = { 
				remove_character_modifier = child
				any_dynasty_member = {
					limit = { is_alive = yes }
					character_event = { id = tower_of_joy.35 }
				}
			}
		}
		add_character_modifier = {
			name = "wedding"
			duration = 60
		}
		hidden_tooltip = { character_event = { id = tower_of_joy.31 } }
	}
}
# Lyanna dies, with child
narrative_event = {
	id = tower_of_joy.26
	title = "EVTNAMEtower_of_joy.5"
	desc = "EVTDESCtower_of_joy.26"
	picture = "GFX_tower_of_joy"
	border = "GFX_event_narrative_frame_religion"
	
	is_triggered_only = yes
	
	hide_from = yes
	
	trigger = {
		character = 77039 #Rhaegar
	}

	immediate = {
		set_character_flag = tower_of_joy
	}

	option = {
		name = "EVTOPTAtower_of_joy.27" # Send her back to winterfell
		c_4059 = { #Lyanna
			#death = yes
			hidden_tooltip = { 
				#remove_trait = has_missing
				any_dynasty_member = {
					limit = { is_alive = yes }
					character_event = { id = tower_of_joy.131 }
				}
			}
		}
		piety = 50
		random = {
			chance = 30
			add_trait = depressed
			hidden_tooltip = {
				character_event = {
					id = 38288 #Notify Depressed
				}
			}
		}
		narrative_event = { id = tower_of_joy.38 tooltip = TOOLTIPtower_of_joy.38 }
	}
	
	option = {
		name = "EVTOPTBtower_of_joy.27" # True love
		spouse = {
			opinion = {
				who = ROOT
				modifier = opinion_unfaithful_private
			}
		}
		c_4059 = { #Lyanna
			#death = yes
			hidden_tooltip = { 
				#remove_trait = has_missing
				any_dynasty_member = {
					limit = { is_alive = yes }
					character_event = { id = tower_of_joy.132 }
				}
			}
		}
		random = {
			chance = 15
			add_trait = depressed
			hidden_tooltip = {
				character_event = {
					id = 38288 #Notify Depressed
				}
			}
		}
		narrative_event = { id = tower_of_joy.38 tooltip = TOOLTIPtower_of_joy.38 }
	}
}
# Lyanna dies, no child
narrative_event = {
	id = tower_of_joy.27
	title = "EVTNAMEtower_of_joy.5"
	desc = "EVTDESCtower_of_joy.27"
	picture = "GFX_tower_of_joy"
	border = "GFX_event_narrative_frame_religion"
	
	is_triggered_only = yes
	
	hide_from = yes
	
	trigger = {
		character = 77039 #Rhaegar
	}

	immediate = {
		set_character_flag = tower_of_joy
	}

	option = {
		name = "EVTOPTAtower_of_joy.27" # Send her back to winterfell
		c_4059 = { #Lyanna
			death = { death_reason = death_childbirth }
			hidden_tooltip = { 
				remove_trait = has_missing
				any_dynasty_member = {
					limit = { is_alive = yes }
					character_event = { id = tower_of_joy.131 }
				}
			}
		}
		piety = 50
		random = {
			chance = 30
			add_trait = depressed
			hidden_tooltip = {
				character_event = {
					id = 38288 #Notify Depressed
				}
			}
		}
		hidden_tooltip = { character_event = { id = tower_of_joy.128 } }
	}
	
	option = {
		name = "EVTOPTBtower_of_joy.27" # True love
		spouse = {
			opinion = {
				who = ROOT
				modifier = opinion_unfaithful_private
			}
		}
		c_4059 = { #Lyanna
			death = { death_reason = death_childbirth }
			hidden_tooltip = { 
				remove_trait = has_missing
				any_dynasty_member = {
					limit = { is_alive = yes }
					character_event = { id = tower_of_joy.132 }
				}
			}
		}
		random = {
			chance = 15
			add_trait = depressed
			hidden_tooltip = {
				character_event = {
					id = 38288 #Notify Depressed
				}
			}
		}
		hidden_tooltip = { character_event = { id = tower_of_joy.129 } }
	}
}
##Post Choice Event##
# Sent Lyanna Home
character_event = {
	id = tower_of_joy.28
	desc = "EVTDESCtower_of_joy.28"
	picture = GFX_evt_quarrel
	
	hide_from = yes
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.28" 
	}
}	
# Imprisoned Lyanna
character_event = {
	id = tower_of_joy.29
	desc = "EVTDESCtower_of_joy.29"
	picture = GFX_evt_into_the_dungeon
	
	hide_from = yes
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.29" 
	}
}	
# Lyanna is lover
character_event = {
	id = tower_of_joy.30
	desc = "EVTDESCtower_of_joy.30"
	picture = GFX_evt_lovers
	
	hide_from = yes
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.30" 
	}
}	
# Lyanna is Queen
character_event = {
	id = tower_of_joy.31
	desc = "EVTDESCtower_of_joy.31"
	picture = "GFX_evt_marriage"
	
	hide_from = yes
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.31" 
	}
}
# Sent body home
character_event = {
	id = tower_of_joy.128
	desc = "EVTDESCtower_of_joy.128"
	picture = GFX_evt_drunk
	
	hide_from = yes
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.128" 
	}
}	
# Buried Lyanna
character_event = {
	id = tower_of_joy.129
	desc = "EVTDESCtower_of_joy.129"
	picture = GFX_evt_drunk
	
	hide_from = yes
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.129" 
	}
}
#Inform Stark/Baratheon
# Sent Lyanna Home
character_event = {
	id = tower_of_joy.32
	desc = "EVTDESCtower_of_joy.32"
	picture = "GFX_tower_of_joy"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.32" 
	}
}	
# Imprisoned Lyanna
character_event = {
	id = tower_of_joy.33
	desc = "EVTDESCtower_of_joy.33"
	picture = "GFX_tower_of_joy"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.33" 
	}
}	
# Lyanna is lover
character_event = {
	id = tower_of_joy.34
	desc = "EVTDESCtower_of_joy.34"
	picture = "GFX_tower_of_joy"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.34" 
	}
}	
# Lyanna is Queen
character_event = {
	id = tower_of_joy.35
	desc = "EVTDESCtower_of_joy.35"
	picture = "GFX_tower_of_joy"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.35" 
	}
}
# Sent body home
character_event = {
	id = tower_of_joy.131
	desc = "EVTDESCtower_of_joy.131"
	picture = "GFX_tower_of_joy"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.131" 
	}
}	
# Buried Lyanna
character_event = {
	id = tower_of_joy.132
	desc = "EVTDESCtower_of_joy.132"
	picture = "GFX_tower_of_joy"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.132" 
	}
}
##Inform Dorne
# Lyanna is lover
character_event = {
	id = tower_of_joy.36
	desc = "EVTDESCtower_of_joy.36"
	picture = "GFX_tower_of_joy"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.36" 
	}
}	
# Lyanna is Queen
character_event = {
	id = tower_of_joy.37
	desc = "EVTDESCtower_of_joy.37"
	picture = "GFX_tower_of_joy"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.37" 
	}
}
###Bastard choice event##
narrative_event = {
	id = tower_of_joy.38
	title = "EVTNAMEtower_of_joy.5"
	desc = "EVTDESCtower_of_joy.38"
	picture = GFX_evt_guardian
	
	is_triggered_only = yes
	
	hide_from = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.26" # Send baby home
		c_4059 = { #Lyanna
			custom_tooltip = { text = TOOLTIPTOJSENDHOMEDEAD }
			hidden_tooltip = {
				create_character = {
					female = no
					age = 0
					dna="decfbzliecd"
					properties="0t00i"
					culture = northman
					historical = yes
				}
				new_character = {
					set_father = ROOT
					set_mother = PREV
					dynasty = PREV
					add_trait = bastard
					give_nickname = nick_snow
					random_dynasty_member = { 
						limit = { 
							is_alive = yes 
							OR = {
								demesne_size = 1
								NOT = { liege = { dynasty = 496 } }
							}
						}
						if = {
							limit = { demesne_size = 1 }
							reverse_banish = PREV
						} 
						if = {
							limit = { NOT = { demesne_size = 1 } }
							liege = { reverse_banish = PREVPREV }
						}
					}
				}
			}
			hidden_tooltip = { death = { death_reason = death_childbirth } remove_trait = has_missing }
		}
		piety = 50
	}
	
	option = {
		name = "EVTOPTBtower_of_joy.26" # Kill
		c_4059 = { #Lyanna
			custom_tooltip = { text = TOOLTIPTOJCHILDKILL }
			hidden_tooltip = {
				create_character = {
					female = no
					age = 0
					dna="decfbzliecd"
					properties="0t00i"
					culture = northman
					historical = yes
				}
				new_character = {
					set_father = ROOT
					set_mother = PREV
					dynasty = PREV
					add_trait = bastard
					give_nickname = nick_snow
					imprison = ROOT
					death = {
						death_reason = death_execution
						killer = ROOT
					}
				}
			}
			hidden_tooltip = { death = { death_reason = death_childbirth } remove_trait = has_missing }
		}
		piety = -150
	}
	
	option = {
		name = "EVTOPTCtower_of_joy.26" # Look after her child
		c_4059 = { #Lyanna
			custom_tooltip = { text = TOOLTIPTOJACKNOWLEDGE }
			hidden_tooltip = {
				create_character = {
					name = ילמם
					female = no
					age = 0
					dna="decfbzliecd"
					properties="0t00i"
					culture = northman
					historical = yes
				}
				new_character = {
					culture = high_valyrian
					religion = the_seven
					set_father = ROOT
					set_mother = PREV
					dynasty = ROOT
					add_trait = bastard
					give_nickname = nick_waters
					move_character = ROOT
				}
			}
			hidden_tooltip = { death = { death_reason = death_childbirth } remove_trait = has_missing }
		}
		spouse = {
			opinion = {
				who = root
				modifier = acknowledged_bastard
				years = 10
			}
			k_dorne = {
				holder_scope = {
					opinion = {
						who = root
						modifier = acknowledged_bastard
						years = 10
					}
				}	
			}
		}
	}
	
	option = {
		name = "EVTOPTDtower_of_joy.26" # True love
		spouse = {
			opinion = {
				who = ROOT
				modifier = legitimized_bastard
				years = 10
			}
			k_dorne = {
				holder_scope = {
					opinion = {
						who = ROOT
						modifier = opinion_angry
						years = 10
					}
				}	
			}
		}
		any_child = {
			limit = { NOT = { trait = bastard } }
			opinion = {
				who = ROOT
				modifier = legitimized_bastard
				months = 12
			}
		}
		c_4059 = { #Lyanna
			custom_tooltip = { text = TOOLTIPTOJTRUEBORN }
			hidden_tooltip = {
				create_character = {
					name = ילמם
					female = no
					age = 0
					dna="decfbzliecd"
					properties="0t00i"
					culture = northman
					historical = yes
				}
				new_character = {
					culture = high_valyrian
					religion = the_seven
					set_father = ROOT
					set_mother = PREV
					dynasty = ROOT
					move_character = ROOT
				}
			}	
			hidden_tooltip = { death = { death_reason = death_childbirth } remove_trait = has_missing }
		}
	}
}

###R+L=J submod events###
character_event = { #Lyanna Stark 
	id = tower_of_joy.5099
	
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		set_global_flag = tower_of_joy_submod_active #global flag for use in other events
	}
	
	option = {
		name = OK
	}
}
#Post Roberts Rebellion scenario setup
character_event = {
	id = tower_of_joy.50
	
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		character = 1002059
		has_game_rule = { name = r_l_j value = on }
	}
	
	immediate = {
		set_global_flag = tower_of_joy_submod_active #global flag for use in other events
		set_character_flag = jon_snow
		# #Set Rhaegar as jon's real father
		#c_77039 = { #Rhaegar
			# ROOT = { set_real_father = PREV }
			# remove_trait = assign_mission_target
		# }
		#Mark ToJ survivors
		c_greywaterwatch = { #Howland redd
			holder_scope = {
				add_trait = assign_mission_target
				set_character_flag = ToJ_survivor
			}
		}
		c_59 = { #Ned
			add_trait = assign_mission_target
			set_character_flag = ToJ_survivor
		}
	}
	
	option = {
		name = "EVTOPTAtower_of_joy.50"
	}
}
#Jon meets Howland Reed/Tower of Joy survivor
character_event = {
	id = tower_of_joy.51

	hide_window = yes
	min_age = 17
	only_men = yes
	capable_only = yes
	has_character_flag = jon_snow
	prisoner = no
	
	trigger = {
		dynasty = 59
		has_game_rule = { name = r_l_j value = on }
		father_even_if_dead = { character = 59 } #Ned
		#real_father = { character = 77039 } #Rhaegar
		assign_mission_target = {
			is_alive = yes
			has_character_flag = ToJ_survivor		
			NOT = { war_with = ROOT }
			NOT = { has_character_flag = met_jon_snow }
			NOT = { trait = incapable }
			OR = {
				at_location = ROOT
				is_friend = ROOT
			}	
			OR = { #ned must be dead before others can tell Jon
				character = 59 #Ned
				c_59 = { is_alive = no }
			}
		}
		NOT = { has_character_flag = knows_parentage }	
	}
	
	immediate = {
		assign_mission_target = {
			limit = {
				is_alive = yes
				has_character_flag = ToJ_survivor		
				NOT = { war_with = ROOT }
				NOT = { has_character_flag = met_jon_snow }
				NOT = { trait = incapable }
				OR = {
					at_location = ROOT
					is_friend = ROOT
				}
				OR = { #ned must be dead before others can tell Jon
					character = 59 #Ned
					c_59 = { is_alive = no }
				}
			}	
			set_character_flag = met_jon_snow
			character_event = { id = tower_of_joy.52 }
		}
	}
	
	option = {
		name = OK
	}
}	
#Check for survivors when attending events
character_event = {
	id = tower_of_joy.5199

	is_triggered_only = yes
	hide_window = yes
	min_age = 17
	only_men = yes
	capable_only = yes
	has_character_flag = jon_snow
	prisoner = no
	
	trigger = {
		dynasty = 59
		has_game_rule = { name = r_l_j value = on }
		father_even_if_dead = { character = 59 } #Ned
		#real_father = { character = 77039 } #Rhaegar
		NOT = { has_character_flag = knows_parentage }	
	}
	
	immediate = {
		assign_mission_target = {
			limit = {
				is_alive = yes
				has_character_flag = ToJ_survivor		
				NOT = { war_with = ROOT }
				NOT = { has_character_flag = met_jon_snow }
				NOT = { trait = incapable }
				OR = { #ned must be dead before others can tell Jon
					character = 59 #Ned
					c_59 = { is_alive = no }
				}
				OR = {
					AND = {
						has_character_flag = guest_feast_started
						liege = {
							has_character_modifier = holding_large_feast
							OR = {
								character = ROOT
								AND = {
									is_liege_of = ROOT
									ROOT = {
										OR = {
											has_character_flag = guest_feast_started
											is_ruler = no
										}
									}
								}
							}
						}	
					}
					AND = {
						has_character_modifier = holding_large_feast
						is_liege_of = ROOT
						ROOT = { has_character_flag = guest_feast_started }	
					}
					AND = {
						same_realm = ROOT
						has_character_flag = attending_great_council 
						ROOT = { has_character_flag = attending_great_council }
					}
					AND = {
						same_realm = ROOT
						has_character_flag = attending_grand_council
						ROOT = { has_character_flag = attending_grand_council }
					}
					AND = {
						same_realm = ROOT
						has_character_flag = attend_coronation
						ROOT = { has_character_flag = attend_coronation }
					}
					AND = {
						same_realm = ROOT
						OR = {
							has_character_flag = attending_tournament
							has_character_flag = attending_archery_tournament
							has_character_flag = attending_melee
						}
						any_opinion_modifier_target = {
							is_ruler = yes
							OR = {
								has_character_flag = melee_begins
								has_character_flag = tournament_begins
							}
							OR = {			
								reverse_has_opinion_modifier = { who = PREV modifier = opinion_attending_tournament }
								reverse_has_opinion_modifier = { who = PREV modifier = opinion_spectating_tournament }
								reverse_has_opinion_modifier = { who = PREV modifier = opinion_attending_melee }
							}
							OR = {
								character = ROOT
								reverse_has_opinion_modifier = { who = ROOT modifier = opinion_attending_tournament }
								reverse_has_opinion_modifier = { who = ROOT modifier = opinion_spectating_tournament }
								reverse_has_opinion_modifier = { who = ROOT modifier = opinion_attending_melee }
							}
						}	
					}
					AND = {
						is_ruler = yes
						same_realm = ROOT
						OR = {
							has_character_flag = melee_begins
							has_character_flag = tournament_begins
						}
						ROOT = {
							OR = {
								has_character_flag = attending_tournament
								has_character_flag = attending_archery_tournament
								has_character_flag = attending_melee
							}
						}
						OR = {
							reverse_has_opinion_modifier = { who = ROOT modifier = opinion_attending_tournament }
							reverse_has_opinion_modifier = { who = ROOT modifier = opinion_spectating_tournament }
							reverse_has_opinion_modifier = { who = ROOT modifier = opinion_attending_melee }
						}	
					}
					AND = {
						has_character_flag = coming_to_ball
						any_opinion_modifier_target = {
							is_ruler = yes
							has_character_modifier = holding_ball		
							reverse_has_opinion_modifier = { who = PREV modifier = opinion_attending_wedding }
							OR = {
								character = ROOT
								reverse_has_opinion_modifier = { who = ROOT modifier = opinion_attending_wedding }
							}
						}	
					}
					AND = {
						is_ruler = yes
						has_character_modifier = holding_ball	
						ROOT = { has_character_flag = coming_to_ball }
						reverse_has_opinion_modifier = { who = ROOT modifier = opinion_attending_wedding }	
					}
					AND = {
						has_character_flag = attending_funeral
						any_opinion_modifier_target = {
							is_ruler = yes
							has_character_modifier = hosting_a_funeral		
							reverse_has_opinion_modifier = { who = PREV modifier = opinion_attending_funeral }
							OR = {
								character = ROOT
								reverse_has_opinion_modifier = { who = ROOT modifier = opinion_attending_funeral }
							}
						}	
					}
					AND = {
						is_ruler = yes
						has_character_modifier = hosting_a_funeral	
						ROOT = { has_character_flag = attending_funeral }
						reverse_has_opinion_modifier = { who = ROOT modifier = opinion_attending_funeral }	
					}
				}	
			}	
			set_character_flag = met_jon_snow
			character_event = { id = tower_of_joy.52 }
		}
	}
	
	option = {
		name = OK
	}
}	
#reveal Jon's parentage to him?
character_event = {
	id = tower_of_joy.52	
	picture = "GFX_tower_of_joy"
	
	desc = {
		text = "EVTDESCtower_of_joy.52"
		trigger = { NOT = { character = 59 } }
	}	
	desc = {
		text = "EVTDESCtower_of_joy.52B"
		trigger = { character = 59 }
	}
	
	is_triggered_only = yes
	
	trigger = {
		has_character_flag = ToJ_survivor
	}
	
	immediate = { set_character_flag = met_jon_snow }
	
	option = {
		name = "EVTOPTAtower_of_joy.52" #Yes
		ai_chance = { 
			factor = 50
		}
		FROM = {
			narrative_event = { id = tower_of_joy.53 tooltip = TOOLTIPtower_of_joy.53 }
		}
	}
	
	option = {
		name = "EVTOPTBtower_of_joy.52" #No
		ai_chance = { 
			factor = 50 
			
			modifier = {
				factor = 3
				e_iron_throne = { ROOT = { has_claim = PREV } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = FROM value = -25 } }
			}
			modifier = {
				factor = 20
				NOT = { opinion = { who = FROM value = -50 } }
			}
			modifier = {
				factor = 0
				OR = {
					character = 4059
					trait = honorable
					trait = just
					opinion = { who = FROM value = 0 }
				}
			}
		}
	}
}	
#Jon is informed of true parentage
narrative_event = {
	id = tower_of_joy.53
	title = "EVTNAMEtower_of_joy.53"
	picture = "GFX_tower_of_joy"
	
	desc = {
		text = "EVTDESCtower_of_joy.53"
		trigger = { FROM = { NOT = { character = 59 } } }
	}	
	desc = {
		text = "EVTDESCtower_of_joy.53B"
		trigger = { FROM = { character = 59 } }
	}
	
	is_triggered_only = yes
	
	trigger = {
		dynasty = 59
		has_character_flag = jon_snow
		father_even_if_dead = { character = 59 } #Ned
		#real_father = { character = 77039 } #Rhaegar
		FROM = { has_character_flag = ToJ_survivor }
		NOT = { has_character_flag = knows_parentage }
		has_game_rule = { name = r_l_j value = on }
	}
	
	immediate = { set_character_flag = knows_parentage }
	
	option = {
		name = "EVTOPTAtower_of_joy.53" #Keep quiet
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				trait = shy
			}
			modifier = {
				factor = 2
				trait = craven
			}
			modifier = {
				factor = 2
				trait = patient
			}
			modifier = {
				factor = 2
				trait = humble
			}
			modifier = {
				factor = 1.5
				e_iron_throne = { holder_scope = { reverse_opinion = { who = ROOT value = 50 } } }
			}
			modifier = {
				factor = 1.5
				e_iron_throne = { holder_scope = { reverse_opinion = { who = ROOT value = 75 } } }
			}
			modifier = {
				factor = 1.5
				e_iron_throne = { holder_scope = { reverse_opinion = { who = ROOT value = 100 } } }
			}
		}
		custom_tooltip = { text = TOOLTIPtower_of_joy.53A }
		FROM = {
			character_event = { id = tower_of_joy.5399 }
		}
	}
	
	option = {
		name = "EVTOPTBtower_of_joy.53" #Claim the Iron Throne
		trigger = {
			OR = {
				NOT = { trait = nightswatch }
				has_landed_title = d_nightswatch
			}
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0
				OR = {
					has_landed_title = d_nightswatch
					trait = content
					trait = honorable
				}
			}
			modifier = {
				factor = 0
				FROM = { character = 59 }
				is_ruler = no
				NOT = { trait = ambitious }
			}
			modifier = {
				factor = 3
				trait = ambitious
			}
			modifier = {
				factor = 3
				trait = ruthless
			}
			modifier = {
				factor = 2
				trait = envious
			}
			modifier = {
				factor = 2
				trait = brave
			}
			modifier = {
				factor = 2
				trait = wroth
			}
			modifier = {
				factor = 2
				trait = proud
			}
			modifier = {
				factor = 1.5
				NOT = { e_iron_throne = { holder_scope = { reverse_opinion = { who = ROOT value = -49 } } } }
			}
			modifier = {
				factor = 1.5
				NOT = { e_iron_throne = { holder_scope = { reverse_opinion = { who = ROOT value = -74 } } } }
			}
			modifier = {
				factor = 1.5
				NOT = { e_iron_throne = { holder_scope = { reverse_opinion = { who = ROOT value = -99 } } } }
			}
		}
		e_iron_throne = { 
			add_pressed_claim = ROOT
			holder_scope = {
				opinion = {
					who = ROOT
					modifier = opinion_traitor
				}
			}
			any_character = {
				limit = { 
					has_claim = PREV
					NOT = { character = ROOT }
				}
				opinion = {
					who = ROOT
					modifier = opinion_traitor
				}
			}
		}
		
		if = {
			limit = { has_landed_title = d_nightswatch }
			add_character_modifier = {
				name = NW_broken_vows
				duration = -1
			}
		}
		set_character_flag = revealed_parentage
		hidden_tooltip = {
			any_player = {
				limit = { 
					OR = {
						dynasty = 496
						dynasty = 59
						capital_scope = { region = world_westeros }
						has_character_flag = ToJ_survivor
						character = FROM
					}
					NOT = { character = ROOT }
				}
				letter_event = { id = tower_of_joy.54 }
			}	
			letter_event = { id = tower_of_joy.54 }
		}
	}
}
character_event = { #Inform surivor Jon keeps quiet for now
	id = tower_of_joy.5399
	desc = "EVTDESCtower_of_joy.5399"
	picture = "GFX_tower_of_joy"
	
	is_triggered_only = yes

	option = {
		name = "EVTOPTAtower_of_joy.5399"
	}
}	
letter_event = { #Inform realm
	id = tower_of_joy.54
	desc = "EVTDESCtower_of_joy.54"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTAtower_of_joy.54" #Interesting
		trigger = { 
			NOT = { has_landed_title = e_iron_throne } 
			NOT = { character = FROM }
		}
	}
	
	option = {
		name = "EVTOPTBtower_of_joy.54" #traitor!
		trigger = { 
			NOT = { character = FROM }
		}
	}
	
	option = {
		name = "EVTOPTCtower_of_joy.54"
		trigger = { character = FROM }
	}
}	
#jon chooses dynasty
character_event = { 
	id = tower_of_joy.55
	desc = "EVTDESCtower_of_joy.55"
	
	is_triggered_only = yes
	
	trigger = {
		OR = {
			character = 1002059
			has_character_flag = jon_snow
		}
		father_even_if_dead = { character = 77039 } #Rhaegar
	}
	
	option = {
		name = "EVTOPTAtower_of_joy.55" #Targaryen
		hidden_tooltip = {
			any_child_even_if_dead = {
				limit = { dynasty = ROOT }
				dynasty=496
				any_child_even_if_dead = {
					limit = { dynasty = ROOT }
					dynasty=496
					any_child_even_if_dead = {
						limit = { dynasty = ROOT }
						dynasty=496
					}
				}
			}
		}	
		dynasty = 496
	}
	
	option = {
		name = "EVTOPTBtower_of_joy.55" #Stark
		if = {
			limit = { NOT = { dynasty = 59 } }
			hidden_tooltip = {
				any_child_even_if_dead = {
					limit = { dynasty = ROOT }
					dynasty=59
					any_child_even_if_dead = {
						limit = { dynasty = ROOT }
						dynasty=59
						any_child_even_if_dead = {
							limit = { dynasty = ROOT }
							dynasty=59
						}
					}
				}
			}	
			dynasty = 59
		}
	}
	option = {
		name = "EVTOPTCtower_of_joy.55" #Both
		hidden_tooltip = {
			any_child_even_if_dead = {
				limit = { dynasty = ROOT }
				dynasty=1559
				any_child_even_if_dead = {
					limit = { dynasty = ROOT }
					dynasty=1559
					any_child_even_if_dead = {
						limit = { dynasty = ROOT }
						dynasty=1559
					}
				}
			}
		}	
		dynasty = 1559
	}
	after = {
		random_bloodline = {
			limit = { has_bloodline_flag = targaryen }
			add_bloodline_member = ROOT
			save_event_target_as = targ_bloodline
		}
		random_bloodline = {
			limit = { has_bloodline_flag = stark }
			add_bloodline_member = ROOT
			save_event_target_as = stark_bloodline
		}
		hidden_tooltip = {
			#Bloodlines
			any_child_even_if_dead = {
				limit = { NOT = { trait = bastard } }
				add_to_bloodline = event_target:targ_bloodline
				add_to_bloodline = event_target:stark_bloodline
				any_child_even_if_dead = {
					limit = { 
						NOT = { trait = bastard } 
						OR = {
							dynasty = ROOT
							PREV = { is_female = no }
						}
					}
					add_to_bloodline = event_target:targ_bloodline
					add_to_bloodline = event_target:stark_bloodline
					any_child_even_if_dead = {
						limit = { 
							NOT = { trait = bastard } 
							OR = {
								dynasty = ROOT
								PREV = { is_female = no }
							}
						}
						add_to_bloodline = event_target:targ_bloodline
						add_to_bloodline = event_target:stark_bloodline
					}
				}
			}
			#check valyrian steel ancestral claims
			if = {
				limit = { 
					OR = { 
						dynasty = 59 
						dynasty = 1559
					} 
				}
				any_character = {
					limit = {
						any_artifact = {
							OR = {
								artifact_type = ice
								artifact_type = widowswail
								artifact_type = oathkeeper
							}
						}
					}
					any_artifact = {
						limit = {
							OR = {
								artifact_type = ice
								artifact_type = widowswail
								artifact_type = oathkeeper
							}
						}
						if = {
							limit = { NOT = { any_artifact_owner = { dynasty = ROOT } } }
							set_artifact_flag = heirloom_@ROOT
							transfer_artifact = { from = PREV to = ROOT}
							transfer_artifact = { from = ROOT to = PREV }
						}
						if = {
							limit = { NOT = { any_artifact_owner = { dynasty = 59 } } }
							random_character = {
								limit = { 
									dynasty = 59 #Stark 
									dynasty_head = { character = PREV }
								} 
								save_event_target_as = heirloom_holder
							}	
							set_artifact_flag = heirloom_@event_target:heirloom_holder
							transfer_artifact = { from = PREV to = event_target:heirloom_holder }
							transfer_artifact = { from = event_target:heirloom_holder to = PREV }
						}
					}
				}
			}
			if = {
				limit = { 
					OR = { 
						dynasty = 496 
						dynasty = 1559
					} 
				}
				any_character = {
					limit = {
						any_artifact = {
							OR = {
								artifact_type = blackfyre 
								artifact_type = darksister 
							}
						}
					}
					any_artifact = {
						limit = {
							OR = {
								artifact_type = blackfyre 
								artifact_type = darksister 
							}
						}
						if = {
							limit = { NOT = { any_artifact_owner = { dynasty = ROOT } } }
							set_artifact_flag = heirloom_@ROOT
							transfer_artifact = { from = PREV to = ROOT}
							transfer_artifact = { from = ROOT to = PREV }
						}
						if = {
							limit = { NOT = { any_artifact_owner = { dynasty = 59 } } }
							random_character = {
								limit = { 
									dynasty = 59 #Stark 
									dynasty_head = { character = PREV }
								} 
								save_event_target_as = heirloom_holder
							}	
							set_artifact_flag = heirloom_@event_target:heirloom_holder
							transfer_artifact = { from = PREV to = event_target:heirloom_holder }
							transfer_artifact = { from = event_target:heirloom_holder to = PREV }
						}
					}
				}
			}
			
			set_dynasty_flag = has_dynamic_coa
			character_event = { id = dynamic_coa.1 }
		}
	}	
}
	